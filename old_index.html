<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <title>CSV Studio â€” Upsert & Delete</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- PapaParse for robust CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      /* Light (SaaS / Material-ish) */
      --bg: #f6f8fb;
      --surface: #ffffff;
      --surface-2: #f2f5fb;
      --text: #0e1726;
      --muted: #5b6b82;
      --border: #d9e1ee;
      --border-2: #cbd5e1;

      --primary: #2563eb;     /* buttons/active */
      --primary-700: #1d4ed8;
      --primary-100: #e8efff;

      --ok: #16a34a;
      --warn: #f59e0b;
      --danger: #ef4444;

      --radius: 12px;
      --shadow-1: 0 2px 10px rgba(16, 24, 40, 0.06);
      --shadow-2: 0 8px 30px rgba(16, 24, 40, 0.1);
    }

    [data-theme="dark"] {
      --bg: #0b1220;
      --surface: #121a2b;
      --surface-2: #0f1726;
      --text: #e8eef7;
      --muted: #93a6c6;
      --border: #22314e;
      --border-2: #2b3a5a;

      --primary: #5b9cff;
      --primary-700: #3b82f6;
      --primary-100: #1c2945;

      --ok: #39d353;
      --warn: #f4b740;
      --danger: #ff6b6b;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.45 Inter, Segoe UI, system-ui, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* App frame */
    .app {
      display: grid;
      grid-template-rows: auto 1fr;
      min-height: 100dvh;
    }

    .topbar {
      position: sticky; top: 0; z-index: 10;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow-1);
    }

    .topbar-inner {
      display: flex; gap: 12px; align-items: center;
      padding: 12px 16px; max-width: 1200px; margin: 0 auto;
    }

    .brand {
      display: flex; gap: 10px; align-items: center; font-weight: 800; letter-spacing: .2px;
    }
    .brand .logo {
      width: 28px; height: 28px; border-radius: 8px;
      background: linear-gradient(135deg, var(--primary), var(--primary-700));
      display: grid; place-items: center; color: #fff; font-size: 16px;
      box-shadow: var(--shadow-1);
    }

    .grow { flex: 1; }

    .segmented {
      display: inline-flex; border: 1px solid var(--border);
      border-radius: 999px; overflow: hidden; background: var(--surface-2);
    }
    .segmented button {
      padding: 8px 14px; border: 0; background: transparent; color: var(--muted);
      font-weight: 600; cursor: pointer; transition: .15s;
    }
    .segmented button.active {
      background: var(--primary); color: #fff;
    }
    .segmented button:focus-visible { outline: 2px solid var(--primary-700); outline-offset: 2px; }

    .btn {
      background: var(--primary); color: #fff; border: 0; padding: 10px 14px;
      border-radius: 10px; cursor: pointer; font-weight: 700;
      box-shadow: var(--shadow-1);
    }
    .btn.secondary { background: transparent; color: var(--text); border: 1px solid var(--border); }
    .btn.ghost { background: transparent; color: var(--text); }
    .btn.ok { background: var(--ok); color: #08121e; }
    .btn.danger { background: var(--danger); }
    .btn:disabled { opacity: .55; cursor: not-allowed; }

    main {
      max-width: 1200px; margin: 16px auto; padding: 0 16px 28px;
      width: 100%;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-1);
      padding: 16px;
    }

    .header-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    h1 { font-size: 22px; margin: 0; }
    p.sub { color: var(--muted); margin: 4px 0 0; }

    .grid {
      display: grid; gap: 16px;
    }
    .grid-2 { grid-template-columns: 1fr 1fr; }
    @media (max-width: 920px) { .grid-2 { grid-template-columns: 1fr; } }

    label { color: var(--muted); font-size: 12px; display: block; margin-bottom: 6px; }
    input[type="text"], input[type="search"], select, textarea {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
      background: transparent; color: var(--text);
    }
    input:focus-visible, select:focus-visible, textarea:focus-visible {
      outline: 2px solid var(--primary-700); outline-offset: 1px;
    }

    .drop {
      border: 2px dashed var(--border-2); border-radius: 12px; padding: 18px;
      text-align: center; color: var(--muted); background: var(--surface-2);
      transition: .15s; cursor: pointer;
    }
    .drop.drag { border-color: var(--primary); color: var(--primary); background: var(--primary-100); }
    .drop input { display: none; }
    .file-name { margin-top: 6px; color: var(--text); font-size: 13px; }

    .hint { color: var(--muted); font-size: 12px; }
    .stat { color: var(--muted); font-size: 12px; white-space: pre-wrap; }

    /* Stepper */
    .stepper {
      display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 8px;
    }
    .step {
      display: flex; align-items: center; gap: 8px; color: var(--muted);
    }
    .dot {
      width: 22px; height: 22px; border-radius: 999px;
      border: 2px solid var(--border-2); display: grid; place-items: center; font-weight: 700;
    }
    .dot.active { background: var(--primary); color: #fff; border-color: var(--primary); }

    /* Tables */
    .table-wrap {
      border: 1px solid var(--border); border-radius: 12px; overflow: auto; max-height: 440px;
      background: var(--surface);
    }
    table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 12px; }
    thead th {
      position: sticky; top: 0; z-index: 1; background: var(--surface-2);
      text-align: left; padding: 8px; border-bottom: 1px solid var(--border);
    }
    tbody td { padding: 6px 8px; border-bottom: 1px solid var(--border); }
    tbody tr:nth-child(even) { background: color-mix(in oklab, var(--surface-2), var(--surface) 65%); }
    .changed { background: color-mix(in oklab, var(--warn) 18%, transparent); }
    .inserted { background: color-mix(in oklab, var(--ok) 16%, transparent); }
    .deleted { background: color-mix(in oklab, var(--danger) 16%, transparent); }

    /* Column picker */
    .colpicker { border: 1px solid var(--border); border-radius: 12px; padding: 10px; background: var(--surface); }
    .colpicker .toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 10px; }
    .colpicker .list { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 8px; max-height: 210px; overflow: auto; }
    .colpicker .item { display: flex; align-items: center; gap: 8px; font-size: 12px; }

    /* Sticky actions */
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }

    /* Toast */
    .toast {
      position: fixed; right: 16px; bottom: 16px; background: var(--surface);
      border: 1px solid var(--border); padding: 10px 14px; border-radius: 10px;
      box-shadow: var(--shadow-2); display: none;
    }
    .toast.show { display: block; }
    .toast.ok { border-color: var(--ok); }
    .toast.warn { border-color: var(--warn); }
    .toast.err { border-color: var(--danger); }

    .visually-hidden {
      position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px, 1px);
      white-space: nowrap; border: 0; padding: 0; margin: -1px;
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Top App Bar -->
    <header class="topbar">
      <div class="topbar-inner">
        <div class="brand" aria-label="CSV Studio">
          <div class="logo">CSV</div>
          <div>CSV Studio</div>
        </div>

        <div class="grow"></div>

        <!-- Mode Tabs -->
        <div class="segmented" role="tablist" aria-label="Operation Mode">
          <button id="tab-upsert" class="active" role="tab" aria-selected="true" aria-controls="panel-upsert">Upsert</button>
          <button id="tab-delete" role="tab" aria-selected="false" aria-controls="panel-delete">Delete</button>
        </div>

        <!-- Theme toggle -->
        <button class="btn secondary" id="theme-btn" aria-label="Toggle theme">ðŸŒ— Theme</button>
      </div>
    </header>

    <main>
      <!-- Title -->
      <div class="card" style="margin-bottom: 12px;">
        <div class="header-row">
          <div>
            <h1>Upsert & Delete â€” CSV Toolkit</h1>
            <p class="sub">Update, insert, or remove rows while preserving the original order. Clean previews, Excelâ€‘friendly paste, and oneâ€‘click export.</p>
          </div>
        </div>
      </div>

      <!-- Stepper -->
      <div class="card" style="margin-bottom: 12px;">
        <div class="stepper">
          <div class="step"><span class="dot active" id="dot-1">1</span> <span>Files</span></div>
          <div class="step"><span class="dot" id="dot-2">2</span> <span>Keys & Columns</span></div>
          <div class="step"><span class="dot" id="dot-3">3</span> <span>Preview & Export</span></div>
        </div>
      </div>

      <!-- UPSERT -->
      <section id="panel-upsert" role="tabpanel" aria-labelledby="tab-upsert">
        <!-- Step 1 -->
        <div class="grid grid-2">
          <div class="card">
            <label>Original CSV</label>
            <div class="drop" id="drop-orig" tabindex="0" aria-label="Upload original CSV"><input type="file" id="orig-file" accept=".csv" />Drop or click to select</div>
            <div class="file-name" id="orig-name"></div>
          </div>
          <div class="card">
            <label>Modifications CSV</label>
            <div class="drop" id="drop-mods" tabindex="0" aria-label="Upload modifications CSV"><input type="file" id="mods-file" accept=".csv" />Drop or click to select</div>
            <div class="file-name" id="mods-name"></div>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="grid grid-2" style="margin-top: 12px;">
          <div class="card">
            <label>Unique Column (must exist in both files)</label>
            <select id="upsert-key" disabled></select>
            <p class="hint">We only show header names present in both CSVs.</p>
          </div>
          <div class="card">
            <label>Output Schema</label>
            <select id="header-mode">
              <option value="original" selected>Keep Original column order</option>
              <option value="union">Union (Original first, then new columns from Modifications)</option>
            </select>
          </div>
        </div>

        <!-- Column picker -->
        <div class="card" style="margin-top: 12px;">
          <div class="colpicker">
            <div class="toolbar" data-for="upsert-col-list">
              <strong>Columns to Preview</strong>
              <input type="search" id="upsert-col-search" placeholder="Filter columnsâ€¦" />
              <button class="btn secondary" id="upsert-col-all" disabled>Select all</button>
              <button class="btn secondary" id="upsert-col-clear" disabled>Clear</button>
              <span class="hint" id="upsert-col-count"></span>
              <label style="margin-left:auto;">
                <input type="checkbox" id="upsert-only-changed" />
                Show only changed columns (key always visible)
              </label>
            </div>
            <div class="list" id="upsert-col-list"></div>
          </div>
        </div>

        <!-- Step 3 + Actions -->
        <div class="grid grid-2" style="margin-top: 12px;">
          <div class="card">
            <div class="actions">
              <button class="btn secondary" id="preview-upsert" disabled>Preview (Dry Run)</button>
              <button class="btn ok" id="run-upsert" disabled>Run Upsert â†’ Download CSV</button>
              <button class="btn ghost" id="reset-upsert">Reset</button>
            </div>
            <div class="stat" id="upsert-summary" style="margin-top:8px;"></div>
          </div>
          <div class="card">
            <div class="hint">Changed cells are highlighted; hover to see previous value.</div>
          </div>
        </div>

        <!-- Tables -->
        <div class="grid grid-2" style="margin-top: 12px;">
          <div class="card">
            <div class="header-row" style="justify-content:space-between;">
              <strong>Updates Preview</strong>
              <span class="hint">Rows whose values will change</span>
            </div>
            <div class="table-wrap" aria-busy="false">
              <table id="upsert-updates-table"><thead></thead><tbody></tbody></table>
            </div>
          </div>
          <div class="card">
            <div class="header-row" style="justify-content:space-between;">
              <strong>Inserted Rows</strong>
              <span class="hint">New rows that will be appended at the end</span>
            </div>
            <div class="table-wrap" aria-busy="false">
              <table id="upsert-inserts-table"><thead></thead><tbody></tbody></table>
            </div>
          </div>
        </div>
      </section>

      <!-- DELETE -->
      <section id="panel-delete" role="tabpanel" aria-labelledby="tab-delete" hidden>
        <!-- Step 1 -->
        <div class="grid grid-2">
          <div class="card">
            <label>Original CSV</label>
            <div class="drop" id="drop-del-orig" tabindex="0" aria-label="Upload original CSV for delete"><input type="file" id="del-orig-file" accept=".csv" />Drop or click to select</div>
            <div class="file-name" id="del-orig-name"></div>
          </div>
          <div class="card">
            <label>Unique Column (from Original)</label>
            <select id="delete-key" disabled></select>
            <p class="hint">Example: orders__ExternalId__c</p>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="grid grid-2" style="margin-top: 12px;">
          <div class="card">
            <label>Paste IDs (one per line, or comma/semicolon/tab separated)</label>
            <textarea id="delete-ids" rows="8" placeholder="Paste hereâ€¦"></textarea>
            <div class="actions" style="margin-top: 8px;">
              <label><input type="checkbox" id="opt-trim" checked/> Trim</label>
              <label><input type="checkbox" id="opt-dedup" checked/> Dedupe</label>
              <label><input type="checkbox" id="opt-ci" /> Caseâ€‘insensitive</label>
              <button class="btn secondary" id="clean-ids">Clean IDs</button>
            </div>
            <span class="stat" id="ids-stats"></span>
          </div>

          <div class="card">
            <div class="colpicker">
              <div class="toolbar" data-for="delete-col-list">
                <strong>Columns to Preview</strong>
                <input type="search" id="delete-col-search" placeholder="Filter columnsâ€¦" />
                <button class="btn secondary" id="delete-col-all" disabled>Select all</button>
                <button class="btn secondary" id="delete-col-clear" disabled>Clear</button>
                <span class="hint" id="delete-col-count"></span>
              </div>
              <div class="list" id="delete-col-list"></div>
            </div>
          </div>
        </div>

        <!-- Step 3 + Actions -->
        <div class="grid grid-2" style="margin-top: 12px;">
          <div class="card">
            <div class="actions">
              <button class="btn secondary" id="preview-delete" disabled>Preview (Dry Run)</button>
              <button class="btn danger" id="run-delete" disabled>Run Delete â†’ Download CSV</button>
              <button class="btn ghost" id="reset-delete">Reset</button>
            </div>
            <div class="stat" id="delete-summary" style="margin-top:8px;"></div>
          </div>
          <div class="card">
            <div class="hint">Preview rows to be deleted and review IDs not found before exporting.</div>
          </div>
        </div>

        <!-- Tables -->
        <div class="grid grid-2" style="margin-top: 12px;">
          <div class="card">
            <div class="header-row"><strong>Rows To Delete</strong></div>
            <div class="table-wrap" aria-busy="false">
              <table id="delete-rows-table"><thead></thead><tbody></tbody></table>
            </div>
          </div>
          <div class="card">
            <div class="header-row"><strong>IDs Not Found</strong></div>
            <div class="table-wrap" aria-busy="false">
              <table id="delete-nf-table"><thead><tr><th>ID</th></tr></thead><tbody></tbody></table>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    // ---------------- THEME ----------------
    const themeBtn = document.getElementById('theme-btn');
    themeBtn.addEventListener('click', () => {
      const root = document.documentElement;
      const next = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      root.setAttribute('data-theme', next);
    });

    // ---------------- TOAST ----------------
    const toastEl = document.getElementById('toast');
    function toast(msg, kind = 'ok') {
      toastEl.className = 'toast show ' + (kind === 'ok' ? 'ok' : kind === 'warn' ? 'warn' : 'err');
      toastEl.textContent = msg;
      setTimeout(() => toastEl.className = 'toast', 2200);
    }

    // ---------------- MODE TABS ----------------
    const tabUpsert = document.getElementById('tab-upsert');
    const tabDelete = document.getElementById('tab-delete');
    const panelUpsert = document.getElementById('panel-upsert');
    const panelDelete = document.getElementById('panel-delete');
    const dots = [document.getElementById('dot-1'), document.getElementById('dot-2'), document.getElementById('dot-3')];

    function setStep(n) { dots.forEach((d, i) => d.classList.toggle('active', i === (n - 1))); }
    setStep(1);

    function activateTab(which) {
      const up = which === 'upsert';
      tabUpsert.classList.toggle('active', up);
      tabUpsert.setAttribute('aria-selected', String(up));
      panelUpsert.hidden = !up;

      tabDelete.classList.toggle('active', !up);
      tabDelete.setAttribute('aria-selected', String(!up));
      panelDelete.hidden = up;

      setStep(1);
      toast(up ? 'Upsert mode' : 'Delete mode', 'ok');
    }
    tabUpsert.addEventListener('click', () => activateTab('upsert'));
    tabDelete.addEventListener('click', () => activateTab('delete'));

    // ---------------- DRAG & DROP ----------------
    function wireDrop(div, input, onFile) {
      const add = () => div.classList.add('drag');
      const rm  = () => div.classList.remove('drag');
      const open = () => input.click();

      div.addEventListener('click', open);
      div.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); open(); }});
      div.addEventListener('dragover', (e) => { e.preventDefault(); add(); });
      div.addEventListener('dragleave', (e) => { e.preventDefault(); rm(); });
      div.addEventListener('drop', (e) => {
        e.preventDefault(); rm();
        if (e.dataTransfer.files?.[0]) onFile(e.dataTransfer.files[0]);
      });
      input.addEventListener('change', () => { if (input.files?.[0]) onFile(input.files[0]); });
    }

    // ---------------- CSV PARSE ----------------
    async function parseCSVFile(file) {
      const text = await file.text();
      const res = Papa.parse(text, {
        header: true,
        skipEmptyLines: true,
        transformHeader: (h) => String(h ?? '').trim()
      });
      const rows = res.data || [];
      const headers = (res.meta && res.meta.fields) ? res.meta.fields.map(h => String(h ?? '').trim()) :
                       (rows.length ? Object.keys(rows[0]) : []);
      return { rows, headers, name: file.name };
    }

    // ---------------- TABLE RENDER ----------------
    function renderTable(table, headers, rows, rowClass = null, changedMapByRowFn = null) {
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      thead.innerHTML = ''; tbody.innerHTML = '';
      const trh = document.createElement('tr');
      headers.forEach(h => { const th = document.createElement('th'); th.textContent = h; trh.appendChild(th); });
      thead.appendChild(trh);

      // For very large datasets, render up to a cap, show info
      const CAP = 2000;
      const slice = rows.length > CAP ? rows.slice(0, CAP) : rows;
      slice.forEach(r => {
        const tr = document.createElement('tr');
        if (rowClass) tr.classList.add(rowClass);
        const changedMap = changedMapByRowFn ? changedMapByRowFn(r) : null;
        headers.forEach(h => {
          const td = document.createElement('td');
          const val = r[h] ?? '';
          td.textContent = val;
          if (changedMap && changedMap[h] !== undefined) {
            td.classList.add('changed');
            td.title = `was: ${changedMap[h] ?? ''}`;
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      if (rows.length > CAP) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = headers.length;
        td.className = 'hint';
        td.textContent = `Showing first ${CAP.toLocaleString()} of ${rows.length.toLocaleString()} rowsâ€¦`;
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }

    // ---------------- COLUMN PICKER ----------------
    function buildColPicker(host, allHeaders, onChange) {
      host.innerHTML = '';
      const toolbar = host.parentElement.querySelector('.toolbar');
      const search  = toolbar.querySelector('input[type=search]');
      const btnAll  = toolbar.querySelector('button#' + host.id.replace('list', 'all'));
      const btnClr  = toolbar.querySelector('button#' + host.id.replace('list', 'clear'));
      const countEl = toolbar.querySelector('span#'   + host.id.replace('list', 'count'));

      let selected = new Set(allHeaders);
      let filter = '';

      function updateCount() {
        countEl.textContent = `${selected.size}/${allHeaders.length} selected`;
      }

      function refreshList() {
        host.innerHTML = '';
        const filtered = allHeaders.filter(h => h.toLowerCase().includes(filter));
        filtered.forEach(h => {
          const lab = document.createElement('label'); lab.className = 'item';
          const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = selected.has(h);
          cb.addEventListener('change', () => {
            if (cb.checked) selected.add(h); else selected.delete(h);
            onChange(new Set(selected)); updateCount();
          });
          const txt = document.createElement('span'); txt.textContent = h;
          lab.append(cb, txt); host.appendChild(lab);
        });
        updateCount();
      }

      search.addEventListener('input', () => { filter = search.value.toLowerCase(); refreshList(); });
      if (btnAll) { btnAll.disabled = false; btnAll.addEventListener('click', () => { selected = new Set(allHeaders); refreshList(); onChange(new Set(selected)); }); }
      if (btnClr) { btnClr.disabled = false; btnClr.addEventListener('click', () => { selected.clear(); refreshList(); onChange(new Set(selected)); }); }

      refreshList();
      return { getSelected: () => new Set(selected), setSelected: (s) => { selected = new Set(s); refreshList(); } };
    }

    // ---------------- STATE ----------------
    const state = {
      up: { original: null, mods: null, headersOut: [], key: '', selectedCols: new Set(), updatesAfter: [], inserts: [], changedById: new Map() },
      del: { original: null, key: '', idsList: [], idsSet: new Set(), selectedCols: new Set() }
    };

    // ---------------- UPSERT WIRING ----------------
    const dropOrig = document.getElementById('drop-orig');
    const dropMods = document.getElementById('drop-mods');
    const inOrig   = document.getElementById('orig-file');
    const inMods   = document.getElementById('mods-file');
    const origNameEl = document.getElementById('orig-name');
    const modsNameEl = document.getElementById('mods-name');

    const upsertKey = document.getElementById('upsert-key');
    const headerMode = document.getElementById('header-mode');

    const upsertColList  = document.getElementById('upsert-col-list');
    const upsertColCount = document.getElementById('upsert-col-count');
    const upsertOnlyChanged = document.getElementById('upsert-only-changed');
    const previewUpsert = document.getElementById('preview-upsert');
    const runUpsert     = document.getElementById('run-upsert');
    const resetUpsert   = document.getElementById('reset-upsert');
    const upsertSummary = document.getElementById('upsert-summary');
    const upUpdatesTable = document.getElementById('upsert-updates-table');
    const upInsertsTable = document.getElementById('upsert-inserts-table');

    wireDrop(dropOrig, inOrig, async (file) => {
      const parsed = await parseCSVFile(file);
      state.up.original = parsed;
      origNameEl.textContent = `âœ” ${parsed.name} (${parsed.rows.length} rows)`;
      toast('Original uploaded', 'ok'); setStep(2); tryEnableUpsert();
    });
    wireDrop(dropMods, inMods, async (file) => {
      const parsed = await parseCSVFile(file);
      state.up.mods = parsed;
      modsNameEl.textContent = `âœ” ${parsed.name} (${parsed.rows.length} rows)`;
      toast('Modifications uploaded', 'ok'); setStep(2); tryEnableUpsert();
    });

    function tryEnableUpsert() {
      const upo = state.up.original, upm = state.up.mods;
      if (!(upo && upm)) return;

      // common headers
      const setA = new Set(upo.headers);
      const common = upm.headers.filter(h => setA.has(h));
      upsertKey.innerHTML = common.map(h => `<option value="${h}">${h}</option>`).join('');
      upsertKey.disabled = !common.length;
      previewUpsert.disabled = !common.length;
      runUpsert.disabled = !common.length;
      toast(common.length ? 'Pick unique column' : 'No common headers found', common.length ? 'ok' : 'warn');
    }

    upsertKey.addEventListener('change', () => setStep(2));

    function computeUpsertPreviewColumns() {
      const headersOut = state.up.headersOut;
      let cols = headersOut.filter(h => state.up.selectedCols.has(h));
      if (upsertOnlyChanged.checked) {
        const changedSet = new Set();
        state.up.updatesAfter.forEach(row => {
          const id = String(row[state.up.key] ?? '').trim();
          const changed = state.up.changedById.get(id) || {};
          Object.keys(changed).forEach(c => changedSet.add(c));
        });
        changedSet.add(state.up.key);
        cols = cols.filter(c => changedSet.has(c));
        if (!cols.length) cols = [state.up.key];
      }
      if (!cols.length) cols = [state.up.key];
      return cols;
    }

    function renderUpsertTables() {
      const cols = computeUpsertPreviewColumns();
      renderTable(upUpdatesTable, cols, state.up.updatesAfter, null, (row) => {
        const id = String(row[state.up.key] ?? '').trim();
        return state.up.changedById.get(id) || null;
      });
      renderTable(upInsertsTable, cols, state.up.inserts, 'inserted', null);
      upsertColCount.textContent = `${state.up.selectedCols.size}/${state.up.headersOut.length} selected`;
    }

    document.getElementById('upsert-col-all').addEventListener('click', () => {});
    document.getElementById('upsert-col-clear').addEventListener('click', () => {});

    previewUpsert.addEventListener('click', () => {
      const upo = state.up.original, upm = state.up.mods;
      if (!(upo && upm)) return;
      state.up.key = upsertKey.value;

      // headersOut
      state.up.headersOut = [...upo.headers];
      if (headerMode.value === 'union') {
        const seen = new Set(state.up.headersOut);
        upm.headers.forEach(h => { if (!seen.has(h)) { state.up.headersOut.push(h); seen.add(h); } });
      }

      // build modMap
      const modMap = new Map();
      upm.rows.forEach(r => { const id = String(r[state.up.key] ?? '').trim(); if (id) modMap.set(id, r); });

      // compute updates/inserts
      state.up.updatesAfter = [];
      state.up.inserts = [];
      state.up.changedById = new Map();
      let updated = 0, inserted = 0;

      upo.rows.forEach(or => {
        const id = String(or[state.up.key] ?? '').trim();
        if (id && modMap.has(id)) {
          const mr = modMap.get(id);
          const after = { ...or, ...mr };
          const changed = {};
          state.up.headersOut.forEach(h => {
            const before = or[h] ?? '';
            const aft = after[h] ?? '';
            if (String(before) !== String(aft)) changed[h] = before;
          });
          if (Object.keys(changed).length) state.up.changedById.set(id, changed);
          state.up.updatesAfter.push(after);
          modMap.delete(id);
          updated++;
        }
      });
      for (const [, r] of modMap) { state.up.inserts.push(r); inserted++; }

      // column picker
      state.up.selectedCols = new Set(state.up.headersOut);
      buildColPicker(upsertColList, state.up.headersOut, (sel) => { state.up.selectedCols = sel; renderUpsertTables(); });

      upsertSummary.textContent = `Upsert preview â†’ Updated: ${updated}, Inserted: ${inserted}, Output columns: ${state.up.headersOut.length}`;
      renderUpsertTables();
      setStep(3);
      toast('Preview ready', 'ok');
    });

    runUpsert.addEventListener('click', () => {
      const upo = state.up.original, upm = state.up.mods;
      if (!(upo && upm)) return;
      const key = state.up.key;

      // apply changes in place, append inserts (preserve original order)
      const modMap = new Map();
      upm.rows.forEach(r => { const id = String(r[key] ?? '').trim(); if (id) modMap.set(id, r); });

      let updated = 0, inserted = 0;
      upo.rows.forEach(r => {
        const id = String(r[key] ?? '').trim();
        if (id && modMap.has(id)) { Object.assign(r, modMap.get(id)); updated++; modMap.delete(id); }
      });
      for (const [, r] of modMap) { upo.rows.push(r); inserted++; }

      // export CSV with full schema (Original or Union)
      const headersOut = [...upo.headers];
      if (headerMode.value === 'union') {
        const seen = new Set(headersOut);
        state.up.mods.headers.forEach(h => { if (!seen.has(h)) { headersOut.push(h); seen.add(h); } });
      }
      const csv = Papa.unparse({ fields: headersOut, data: upo.rows.map(r => headersOut.map(h => r[h] ?? '')) });
      downloadCSV(csv, 'updated.csv');
      toast(`Upserted: ${updated} / Inserted: ${inserted}`, 'ok');
    });

    resetUpsert.addEventListener('click', () => {
      state.up = { original: null, mods: null, headersOut: [], key: '', selectedCols: new Set(), updatesAfter: [], inserts: [], changedById: new Map() };
      upsertKey.innerHTML = ''; upsertKey.disabled = true;
      previewUpsert.disabled = true; runUpsert.disabled = true;
      origNameEl.textContent = ''; modsNameEl.textContent = '';
      upUpdatesTable.querySelector('thead').innerHTML = '';
      upUpdatesTable.querySelector('tbody').innerHTML = '';
      upInsertsTable.querySelector('thead').innerHTML = '';
      upInsertsTable.querySelector('tbody').innerHTML = '';
      upsertColList.innerHTML = ''; upsertColCount.textContent = '';
      upsertOnlyChanged.checked = false;
      setStep(1); toast('Upsert reset', 'ok');
    });

    // ---------------- DELETE WIRING ----------------
    const dropDelOrig = document.getElementById('drop-del-orig');
    const inDelOrig   = document.getElementById('del-orig-file');
    const delOrigName = document.getElementById('del-orig-name');

    const deleteKey   = document.getElementById('delete-key');
    const deleteIds   = document.getElementById('delete-ids');
    const optTrim     = document.getElementById('opt-trim');
    const optDedup    = document.getElementById('opt-dedup');
    const optCI       = document.getElementById('opt-ci');
    const cleanIDsBtn = document.getElementById('clean-ids');
    const idsStats    = document.getElementById('ids-stats');

    const deleteColList  = document.getElementById('delete-col-list');
    const deleteColCount = document.getElementById('delete-col-count');

    const previewDelete = document.getElementById('preview-delete');
    const runDelete     = document.getElementById('run-delete');
    const resetDelete   = document.getElementById('reset-delete');

    const deleteSummary = document.getElementById('delete-summary');
    const delRowsTable  = document.getElementById('delete-rows-table');
    const delNFBody     = document.querySelector('#delete-nf-table tbody');

    wireDrop(dropDelOrig, inDelOrig, async (file) => {
      const parsed = await parseCSVFile(file);
      state.del.original = parsed;
      delOrigName.textContent = `âœ” ${parsed.name} (${parsed.rows.length} rows)`;
      deleteKey.innerHTML = parsed.headers.map(h => `<option value="${h}">${h}</option>`).join('');
      deleteKey.disabled = !parsed.headers.length;

      // column picker for delete
      state.del.selectedCols = new Set(parsed.headers);
      buildColPicker(deleteColList, parsed.headers, (sel) => {
        state.del.selectedCols = sel;
        if (!previewDelete.disabled) previewDelete.click();
      });
      document.getElementById('delete-col-all').disabled = false;
      document.getElementById('delete-col-clear').disabled = false;

      setStep(2);
      toast('Original uploaded', 'ok');
    });

    function cleanIds() {
      const raw = (deleteIds.value ?? '');
      const parts = raw.split(/[\n\r\t,; ]+/).map(s => s.trim()).filter(Boolean);
      const trim = optTrim.checked, dedup = optDedup.checked, ci = optCI.checked;
      const set = new Set(), list = [];
      for (let p of parts) {
        let k = trim ? p.trim() : p;
        let probe = ci ? k.toLowerCase() : k;
        if (dedup) { if (!set.has(probe)) { set.add(probe); list.push(k); } }
        else { list.push(k); set.add(probe); }
      }
      state.del.idsList = list;
      state.del.idsSet = set;
      idsStats.textContent = `IDs detected: ${parts.length}\nUnique: ${list.length}\nPreview: ${list.slice(0,10).join(', ') || '(none)'}`;
      previewDelete.disabled = !(state.del.original && deleteKey.value && list.length > 0);
      runDelete.disabled = previewDelete.disabled;
      if (!previewDelete.disabled) setStep(3);
    }

    cleanIDsBtn.addEventListener('click', cleanIds);
    deleteIds.addEventListener('input', cleanIds);
    deleteKey.addEventListener('change', cleanIds);

    previewDelete.addEventListener('click', () => {
      const del = state.del.original; if (!del) return;
      const key = deleteKey.value; const ci = optCI.checked;

      const presence = new Set(del.rows.map(r => {
        const raw = String(r[key] ?? '');
        const val = optTrim.checked ? raw.trim() : raw;
        return ci ? val.toLowerCase() : val;
      }));

      const toDelete = del.rows.filter(r => {
        const raw = String(r[key] ?? '');
        const val = optTrim.checked ? raw.trim() : raw;
        const probe = ci ? val.toLowerCase() : val;
        return state.del.idsSet.has(probe);
      });

      const notFound = state.del.idsList.filter(id => {
        const probe = ci ? id.toLowerCase() : id;
        return !presence.has(probe);
      });

      const cols = del.headers.filter(h => state.del.selectedCols.has(h));
      const previewCols = cols.length ? cols : [key];

      renderTable(delRowsTable, previewCols, toDelete, 'deleted', null);
      delNFBody.innerHTML = '';
      notFound.slice(0, 4000).forEach(id => {
        const tr = document.createElement('tr'); const td = document.createElement('td');
        td.textContent = id; tr.appendChild(td); delNFBody.appendChild(tr);
      });

      deleteSummary.textContent = `Delete preview â†’ Will remove: ${toDelete.length} / ${del.rows.length}, IDs not found: ${notFound.length}`;
      toast('Preview ready', 'ok');
    });

    runDelete.addEventListener('click', () => {
      const del = state.del.original; if (!del) return;
      const key = deleteKey.value; const ci = optCI.checked;

      const filtered = del.rows.filter(r => {
        const raw = String(r[key] ?? '');
        const val = optTrim.checked ? raw.trim() : raw;
        const probe = ci ? val.toLowerCase() : val;
        return !state.del.idsSet.has(probe);
      });

      const csv = Papa.unparse({ fields: del.headers, data: filtered.map(r => del.headers.map(h => r[h] ?? '')) });
      downloadCSV(csv, 'updated.csv');
      deleteSummary.textContent = `Delete complete â†’ Removed: ${del.rows.length - filtered.length}, Remaining: ${filtered.length}`;
      toast('Rows deleted', 'ok');
    });

    resetDelete.addEventListener('click', () => {
      state.del = { original: null, key: '', idsList: [], idsSet: new Set(), selectedCols: new Set() };
      deleteKey.innerHTML = ''; deleteKey.disabled = true;
      delOrigName.textContent = '';
      deleteIds.value = ''; idsStats.textContent = '';
      previewDelete.disabled = true; runDelete.disabled = true;
      delRowsTable.querySelector('thead').innerHTML = '';
      delRowsTable.querySelector('tbody').innerHTML = '';
      delNFBody.innerHTML = '';
      deleteColList.innerHTML = ''; deleteColCount.textContent = '';
      setStep(1); toast('Delete reset', 'ok');
    });

    // ---------------- DOWNLOAD ----------------
    function downloadCSV(csv, name = 'updated.csv') {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = name; a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>